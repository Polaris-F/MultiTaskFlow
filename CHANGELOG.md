# 更新日志

## [1.0.6] - 2026年2月10日

### 修复
- **[H1] WebSocket 状态推送崩溃**：修复 `/ws/status` 端点引用不存在的 `manager.history` 属性导致 `AttributeError`，状态实时推送完全不可用
- **[H2] 消息推送重试等待过长**：修复 `Msg_push` 重试逻辑中 `time.sleep` 被重复执行（非 429 场景等待 2 倍、429 场景等待 3 倍预期时间）
- **[H3] 日志文件句柄泄漏**：修复 `run_task` 中打开的日志文件从未关闭，长时间运行导致文件描述符耗尽
  - Task dataclass 新增 `_log_fh` 字段追踪句柄
  - `_monitor_task`、`stop_task`、`retry_task` 中统一关闭
  - `Popen` 失败时回滚状态并关闭句柄
- **[H4] 前端 API 层无 HTTP 错误检查**：所有 API 方法增加统一 `handleResponse` 错误处理，正确抛出后端返回的错误信息
- **[H5] 多队列 retry 找错队列**：修复 `retry_task` API 只在活动任务中查找，现在同时搜索各队列的历史记录
- **[M1] 任务重排丢失非 pending 任务**：`reorder_tasks` 现在保留不在重排列表中的其他任务
- **[M2] QueueTabs 运算符优先级 Bug**：修复 `?? 0 > 0` 优先级错误导致队列运行状态指示灯异常
- **[M3] WebSocket 日志消息解析崩溃**：`LogPanel` 的 WS 消息解析增加 try/catch 防护
- **[M4] ESC 快捷键穿透弹窗**：ESC 关闭日志面板时现在检测是否有弹窗打开，避免冲突
- **[M5] stop_task 与 _monitor_task 竞态条件**：两者在锁保护内互斥处理任务状态转换，避免重复写入历史和 KeyError
- **[M6] 恢复任务时字段类型不匹配**：`_load_from_saved_tasks` 正确将 ISO 字符串转为 `datetime` 对象
- **[M8] TaskDetailDialog 重复 Toast**：删除/移动操作改为 await 异步完成后再显示提示
- **[M9] 通知开关未生效**：`send_task_notification` 现在检查 `.workspace.json` 中的 `notification_enabled` 字段

### 优化
- **[M7] 设置面板精简**：移除未被 TaskTable 消费的无效布局设置项（列宽、自动隐藏列等），保留通知设置并新增通知开关 UI
- **[L1] Logger Handler 去重**：`_setup_logger` 检查是否已配置，避免重复添加 handler
- **[L2] CLI 日志目录改为配置文件目录**：日志现在写入 YAML 配置文件所在目录的 `logs/` 下
- **[L3] 动态加载新任务传递 env 参数**：`check_new_tasks` 创建 Task 时包含 `env` 字段
- **[L4] 恢复任务使用原始 start_time**：WebUI 重启后从持久化数据恢复任务的实际开始时间
- **[L5] 零秒时长正确显示**：`formatDuration(0)` 现在显示 `0s` 而非 `-`
- **[L6] AddQueueDialog 关闭重置表单**：打开时自动清空表单并新增内联错误提示
- **[L7] 清理 WebSocket 死代码**：移除 `LogStreamer` 中未使用的 `file_positions` 和 `line_buffers`
- **[L8] Toolbar 防重复点击**：所有操作按钮增加 `actionLoading` 状态保护
- **[L9] 清理未使用的 prop**：移除 `XTerminal` 的 `onContentUpdate` prop
- **[L10] Header 版本号动态获取**：从 `/health` API 获取版本号，后端 `/health` 端点返回 `version` 字段
- **[L11] 版本注释修正**：`__init__.py` 文件头版本注释从 `0.1.5` 改为 `1.0.6`
- **[L12] 移除误导性安全提示**：LoginPage 底部文字改为中性描述
- **弹窗 modal 标记**：所有弹窗统一添加 `data-mtf-modal="true"` 属性，配合 ESC 检测

---

## [1.0.5] - 2026年2月8日

### 修复
- **Web UI 停止时不再终止运行中的任务**：修复了停止 WebUI 后端时会杀死所有正在运行任务的严重 bug
  - 根因：CLI 模式的信号处理器在 `main()` 入口处被注册，早于 `web` 子命令检查
  - 修复：将信号处理器注册移到 CLI 模式分支内，Web 模式使用自己的生命周期管理

### 优化
- **CLI 模式信号处理改进**：收到终止信号 (Ctrl+C) 时不再自动杀死运行中的任务
  - 显示运行中任务的名称和 PID
  - 提供交互选项：按 Enter 保持任务继续运行（默认），按 k 终止所有任务
  - 5 秒超时后自动选择默认选项（保持任务运行）
  - 提示用户如何手动终止任务 (`kill <PID>`)

---

## [1.0.4] - 2026年2月8日

### 优化
- **任务删除功能增强**：现在可以删除失败（failed）、已停止（stopped）和已完成（completed）状态的任务
  - 之前只有等待中（pending）的任务可以删除，现在只有运行中的任务不能删除
  - 修改了 `TaskDetailDialog.tsx` 中的删除按钮禁用逻辑

---

## [1.0.3] - 2026年2月5日

### 新功能
- **`taskflow status` 命令**：查看运行中的后端服务状态
  - 显示所有运行中的 MultiTaskFlow 后端 PID、端口、工作区、运行时长
  - 支持同时运行多个后端实例（使用不同端口）

- **`taskflow monitor <pid>` 命令**：临时监控指定 PID
  - 监控任意进程，进程结束后发送 PushPlus 通知
  - 支持 `--name` 参数自定义通知中的进程名称
  - 支持 `--silent` 参数静默模式（不发送通知）

---

## [1.0.2] - 2026年2月5日

### 修复
- **任务队列恢复问题**：修复 WebUI 重启后等待中的任务丢失问题
  - 根因：`_load_queue()` 创建 `TaskManager` 后未调用 `load_tasks()`
  - 现在正确从 `.workspace.json` 恢复保存的任务列表

- **任务重复添加问题**：修复"检查 YAML 更新"时已完成的任务仍显示为新任务
  - 根因：`check_yaml_updates()` 只检查内存中的任务，不检查历史记录
  - 现在同时检查当前队列和历史记录中的任务名称

- **手动加载防重检查**：`load-selected-tasks` API 增加重复任务检查
  - 返回消息现在会显示"跳过 X 个重复任务"
  - 防止从弹窗中意外重复添加已存在的任务

### 优化
- **队列加载日志**：跳过队列时显示更详细的原因（YAML 不存在等）

---

## [1.0.1] - 2026年1月27日

### 修复
- **PushPlus 通知主题兼容性**：修复消息在亮色主题下文字不清晰的问题
  - 移除半透明背景色，改用边框样式
  - 使用状态对应颜色显示任务名称，确保对比度
  - 错误信息显式指定红色文字
  - 移除固定深灰色，让文字颜色自适应主题

---

## [1.0.0] - 2026年1月18日 🎉 正式发布

### 🎉 重大更新
- **Web UI 可视化管理界面**：全新的现代化 Web 界面，支持任务的创建、编辑、执行和监控
- **CLI 集成**：通过 `taskflow web` 命令一键启动 Web UI
- **多队列管理**：支持同时管理多个任务队列

### 新功能
- **`taskflow web` 子命令**：支持通过命令行启动 Web UI
  - `taskflow web` - 使用当前目录作为工作空间
  - `taskflow web tasks.yaml` - 加载指定配置文件
  - `taskflow web --port 9000` - 指定自定义端口
  - `taskflow web -w /path/workspace` - 指定工作空间目录
- **消息推送通知**：集成 PushPlus，任务完成/失败时推送通知到微信
  - 支持 Web UI 配置 Token（优先级高于环境变量）
  - 通知包含任务状态、运行时长、最后10行日志
- **会话持久化**：重启后端后无需重新登录，会话有效期7天
- **任务状态智能判断**：通过日志内容分析任务成功/失败状态
- **实时日志查看**：WebSocket 实时推送运行日志

### 优化
- **任务详情对话框**：合并查看和编辑功能，支持模式切换
- **日志面板**：防止自动切换覆盖用户手动选择，修复内容竞态条件
- **XTerminal**：正确处理内容追加和替换逻辑
- **认证保护**：所有 API 端点强制认证

### 安装
```bash
# 基础安装（仅 CLI）
pip install multitaskflow

# 完整安装（CLI + Web UI）
pip install multitaskflow[web]
```

## [0.1.5] - 2025年11月10日
### 新功能
- **任务跳过功能**：支持在配置文件中使用 `status: skipped` 跳过任务执行
  - 加载任务时自动过滤 `status` 为 `skipped` 的任务
  - 日志输出跳过的任务数量和名称
  - 适用于临时禁用某些任务的场景

### 优化
- 新增 `STATUS_SKIPPED` 状态常量
- 改进 `load_tasks()` 方法的日志输出，区分加载和跳过的任务

### 文档
- 更新 README，添加 `status` 字段详细说明
- 添加任务跳过功能的使用示例
- 新增 TODO 章节，规划动态任务管理功能（基于 watchdog 的文件监控）

## [0.1.4] - 2025年11月10日
### 新功能
- **智能环境变量加载**：优先从配置文件同目录加载 `.env` 文件，提升配置管理便利性
  - 优先级顺序：配置文件同目录 > 当前工作目录 > 向上递归查找
  - 未找到时会提示推荐的创建位置
- **环境变量配置检查**：启动时和配置变更时自动显示环境变量配置状态
  - 显示 `.env` 文件加载位置
  - Token 脱敏显示（前6位...后6位）
  - 实时显示 `MTF_SILENT_MODE` 状态
  - 支持彩色输出（需安装 `colorama`，可选）
- **环境变量变更检测**：任务执行前自动检测环境变量变化，有变化时重新显示配置

### 优化
- 每个任务执行前重新加载环境变量，支持运行时修改 `.env` 文件
- 改进日志输出层级，环境变量加载使用 debug 级别
- 添加 `colorama` 作为可选依赖，提供更友好的彩色输出

### 文档
- 更新 README，添加环境变量加载机制说明
- 添加彩色输出可选功能说明


## [0.1.3] - 2025年5月13日
### 新功能
- 增加环境变量静默模式，通过设置MTF_SILENT_MODE环境变量控制是否发送消息通知，适用于无网络或者不想要接收消息场景
### 优化
- 优化日志输出，提供更清晰的任务状态信息

## [0.1.1] - 2025年4月30日



### 修复
- MSG_PUSH_TOKEN环境变量读取问题 

## 2025年5月12日 TODO

1. CLI 命令增加一个 监听单个任务的功能：
    输入 taskflow monitor 'XXX', 其中'XXX'表示需要监听的任务的进程名称，针对已经有一个且只有一个任务已经在跑的场景，通过 monitor 在任务结束发送消息。
<!-- 2. 发送消息改为  -->
